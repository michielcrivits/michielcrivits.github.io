<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<title>Wannes Crivits - Haute Route Pyrenees FKT attempt</title>
		<style type="text/css">
			v\:* {
				behavior:url(#default#VML);
			}
		</style>

		<!-- Make the document body take up the full screen -->
		<style type="text/css">
			html, body {width: 100%; height: 100%}
			body {margin-top: 0px; margin-right: 0px; margin-left: 0px; margin-bottom: 0px}
		</style>

		
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
		<script src="loadgpx.js" type="text/javascript"></script>
        <script src="distanceCalculator.js" type="text/javascript"></script>
		<script type="text/javascript">

		//<![CDATA[

		var MyMap;
        var locations = [];
        var distances = [];
        var totalDistance = 0;

		function loadGPXFileIntoGoogleMap(map, filename)
		{
			var request = new XMLHttpRequest();
			request.open("GET", filename, true);
			request.onreadystatechange = function()
			{
				if (request.readyState == 4)
				{
					parser = new GPXParser(request.responseXML, map);
					parser.setTrackColour("#ff0000");					// Set the track line colour
					parser.setTrackWidth(3);							// Set the track line width
					parser.setMinTrackPointDelta(0.001);				// Set the minimum distance between track points
					parser.centerAndZoom(request.responseXML);			// Center and Zoom the map over all the points.
					parser.addTrackpointsToMap();						// Add the trackpoints
					parser.addWaypointsToMap();							// Add the waypoints
				}
			}
			request.send(null);
		}

        async function initialLoadGPXDistances(filename)
        {
            const xml = await fetch(filename)
            .then((res) => res.text())
            .then((str) =>
                new window.DOMParser().parseFromString(str, "text/xml")
            );
            const coords = Array.from(xml.querySelectorAll("trkpt")).map(
            (element) =>
                new google.maps.LatLng(
                Number(element.getAttribute("lat")),
                Number(element.getAttribute("lon"))
                )
            );
            distances = coords.reduce((old, ne, index, original) => {
            if (index > 0) {
                var trackPnt = {};
                trackPnt.latLng = ne;
                trackPnt.distanceToPreviousTrackPnt = haversine_distance(
                ne,
                original[index - 1]
                );
                old.push(trackPnt);
            } else {
                var trackPnt = {};
                trackPnt.latLng = ne;
                trackPnt.distanceToPreviousTrackPnt = 0;
                old.push(trackPnt);
            }

            return old;
            }, []);

            totalDistance = GetDistanceToTrackPnt(distances.length-1);
            //console.log('nr of distances: ' + distances.length)
        }

        function GetDistanceDone(coord1){
            var index = GetNearestTrackPnt(coord1);
            var distanceDone = GetDistanceToTrackPnt(index);
            return distanceDone;
        }

        function GetNearestTrackPnt(coord1) {
        var indexShortestDistance = -1;
        var shortestDistance = -1;
        
        distances.forEach((element, index) => {
          var distance = haversine_distance(coord1, element.latLng);

          if (shortestDistance == -1 || distance < shortestDistance) {
            shortestDistance = distance;
            indexShortestDistance = index;
          }
        });
        
        return indexShortestDistance;
      }

      function GetDistanceToTrackPnt(index) {
        var totalDistance = 0.0;
        for (let i = 0; i <= index; i++) {
          totalDistance += distances[i].distanceToPreviousTrackPnt;
        }
        return totalDistance;
      }

      function haversine_distance(coord1, coord2) {
    const R = 6371; // Radius of the Earth in km
    const rlat1 = coord1.lat() * (Math.PI / 180); // Convert degrees to radians
    const rlat2 = coord2.lat() * (Math.PI / 180); // Convert degrees to radians
    const difflat = rlat2 - rlat1; // Radian difference (latitudes)
    const difflon = (coord2.lng() - coord1.lng()) * (Math.PI / 180); // Radian difference (longitudes)

    const d =
        2 *
        R *
        Math.asin(
        Math.sqrt(
            Math.sin(difflat / 2) * Math.sin(difflat / 2) +
            Math.cos(rlat1) *
                Math.cos(rlat2) *
                Math.sin(difflon / 2) *
                Math.sin(difflon / 2)
        )
        );
    return d;
    }
                
        function addMarkers() {
        $.getJSON("https://sheets.googleapis.com/v4/spreadsheets/17Qc_MMVV5NTWGC_io--JBPWmEPplBZQOdrlt3sx177A/values/Overview!A5:L7?key=AIzaSyCevCgtTXxREUE-dilAREbSL6_6TmCSpAQ", function (data) {
            $(data.values).each(function () {
                var location = {};
                location.runner = this[0];
                location.startdatetime = this[2];
                location.startdatetimeOriginal = this[1];
                location.enddatetimeOriginal = this[3];
                location.timestamp = this[5];
                location.timestampOriginal = this[6];
                location.latitude = parseFloat(this[7]);
                location.longitude = parseFloat(this[8]);
                location.fkt = this[9];
                location.currentAttempt = this[10];
                location.currentFKT = this[11];
                location.distanceDone = GetDistanceDone(new google.maps.LatLng(Number(parseFloat(this[7])),Number(parseFloat(this[8]))

                
        ))
                locations.push(location);
            });

            setLocations(MyMap, locations);
        });
        }

        function setLocations(map, locations) {
        var bounds = new google.maps.LatLngBounds();
        // Create pop-up boxes, appear when the marker is clicked on
        var infowindow = new google.maps.InfoWindow({
                content: "Content String"
            });
        for (var i = 0; i < locations.length; i++) {
            var new_marker = createMarker(map, locations[i], infowindow);
            bounds.extend(new_marker.position);
        }
        //map.fitBounds(bounds); // zoom to latest marker
        }

        function createMarker(map, location, infowindow) {

        var position = {
            lat: parseFloat(location.latitude),
            lng: parseFloat(location.longitude)
        };
        var marker = new google.maps.Marker({
                position: position,
                map: map,
                title: location.runner + ' (' + location.startdatetime.substring(6, 10) + ')'
            });
        google.maps.event.addListener(marker, 'click', function () {
            var content = '<div>' + '<h2>' + location.runner + ' (' + location.startdatetime.substring(6, 10) + ')' + '</h2>';
            if (location.currentAttempt == "1") {
                content += '<h3>FKT attempt</h3>' +
                '<p>Startdate: ' + location.startdatetime + '<br />' +
                'Latest trackpoint: ' + location.timestamp + '<br /><br />' +
                'Progress: ' + Math.ceil(location.distanceDone) + 'km / ' + Math.ceil(totalDistance) + 'km (' + Math.ceil(Math.ceil(location.distanceDone) / Math.ceil(totalDistance) *100.0)+'%)</p>'
            }
            if (location.currentAttempt != "1") {
                // compared to current attempt
                content += '<h3>Compared to current attempt</h3>' +
                '<p>Startdate: ' + location.startdatetime + '<br />' +
                'Latest trackpoint: ' + location.timestamp + '<br /><br />' +
                'Progress: ' + Math.ceil(location.distanceDone) + 'km / ' + Math.ceil(totalDistance) + 'km (' + Math.ceil(Math.ceil(location.distanceDone) / Math.ceil(totalDistance) *100.0)+'%)</p>'

                // previous attempt
                content += '<h3>Original attempt</h3>' +
                '<p>Startdate: ' + location.startdatetimeOriginal + '<br />' +
                'Enddate: ' + location.enddatetimeOriginal + '<br />' +
                'Distance done: ' + Math.ceil(totalDistance) + 'km (100%)</p>'

                '<p><b>FKT: ' + location.fkt + '</b></p>'
                '</div>';
            }
            infowindow.setContent(content);
            infowindow.open(map, marker);
        });
        return marker;
        }




		async function initialiseMap()
		{
			MyMap = new google.maps.Map(document.getElementById("map"), {
          		center: {lat: 43.373058	, lng: -1.773991},
          		zoom: 10
			});

			loadGPXFileIntoGoogleMap(MyMap, "HRP.gpx.xml");
            await initialLoadGPXDistances("HRP.gpx.xml");

            addMarkers();
		}

		//]]>

        
		</script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCevCgtTXxREUE-dilAREbSL6_6TmCSpAQ&callback=initialiseMap" type="text/javascript"></script>
	</head>
	<body >
        <h1>Wannes Crivits - Haute Route Pyrenees - FKT attempt</h1>
        <p><b>Distance: </b>773.4km</p>
        <p><b>Vertical Gain: </b>25.000m</p>
        <p><b>Current FKT: </b>12d 4h 41m 58s (Mike Coppock, 25/09/2021, self-supported)</p>
        <p>The Haute Route Pyrenees (HRP) follows the French and Spanish border, starting in Hendaye on the Atlantic coast and finishing in Banyuls-sur-Mer on the Mediterranean. Large sections of the route remain unmarked.</p>
        <p>The original HRP route was devised by Georges Véron in 1968 and later adapted and popularised by Ton Joosten’s guidebook "Pyrenean Haute Route" (Cicerone Guide). The HRP described in the 2nd edition of Ton Joosten’s book has total distance of approximately 500 mi (800 km) and an estimated elevation change of 183,000 ft (55,800 m). </p>
        <p>Like with other famous trails, there is not one single HRP route, but variants exist and it is possible switch between the high-route and lower alternatives on the GR 10/GR 11.</p>
        <p><b>Official website: </b><a href="https://fastestknowntime.com/route/haute-route-pyrenees-spain-andorra-france">https://fastestknowntime.com/route/haute-route-pyrenees-spain-andorra-france</a></p>
        <h2>FKT Attempt</h2>
        <b>Startdate: </b>02/08/2023 05:17:30<br />
        <b>Crew: </b>Supported by Wouter Gunst<br />
        <b>Tracker: </b>Garmin Inreach (<a href="https://share.garmin.com/WannesCrivits">https://share.garmin.com/WannesCrivits</a>)<br /><br />
		<div id="map" style="width: 100%; height: 100%;"></div>
	</body>
</html>
